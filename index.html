<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Check product ingredients for pregnancy safety and allergies">
    
    <title>SafeBump - Pregnancy & Allergy Checker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNhZmVCdW1wIC0gUHJlZ25hbmN5ICYgQWxsZXJneSBDaGVja2VyIiwKICAic2hvcnRfbmFtZSI6ICJTYWZlQnVtcCIsCiAgImRlc2NyaXB0aW9uIjogIkNoZWNrIHByb2R1Y3QgaW5ncmVkaWVudHMgZm9yIHByZWduYW5jeSBzYWZldHkgYW5kIGFsbGVyZ2llcyIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmN2ZhIiwKICAidGhlbWVfY29sb3IiOiAiIzY2N2VlYSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFNQUFBQURBQ0FZQUFBQ25VOWZjQUFBQUJITkNTVlFJQ0FnSWZBaGtpQUFBQUFsd1NGbHpBQUFBQVhOU1IwSUFyczRjNlFBQUFBUm5RVTFCQUFDeGp3djhZUVVBQUFCSlNVUkJWSGdCN2RheEVZQWdDQVFnZ0FRUUFJSUFFRUFDQ0FCQkFBZ2dBUVFBSUlBRUVBQ0NBQkJBQWdnQVFRQUlJQUVFQUNDQUJCQUFnZ0FRUUFJSUFFRUFDQyIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIgogICAgfQogIF0KfQ==">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAASAAAAEgARslrQAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAABSJSURBVHgBYWAYBaMgggAQQAIIAEEACCABBIAggAQQAIIAEEACCABBAAggAQQAIIAEEACCABBAAggAQQAIIAEEgCAABJAAAkAQAAJIAAEgCAABJIAAEAQQAIIAEEACCABBAAggAQQAIIAEEACCABBAAggAQQAIIAEEgCAABJAAAkAQAAJIAAEgCAABJIAAEAQQAIIAEEACCABBAAggAQQAIIAEEACCABBAAggAQQAIIAEEgCAABJAAAkAQAAJIAAEgCAABJIAAEAQQAIIAEEACCABBAAggAQQAIIAEEACCABBAAggAQQAIIAEEgCA">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .scan-button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .scan-button:active {
            transform: scale(0.98);
        }

        .scan-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .scan-icon {
            width: 24px;
            height: 24px;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: #f5f7fa;
            padding: 0 20px;
            position: relative;
            color: #999;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        #camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
        }

        #camera-modal.active {
            display: block;
        }

        #camera-video {
            width: 100%;
            height: 100vh;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
        }

        .camera-viewfinder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            height: 200px;
            border: 3px solid #00b4d8;
            border-radius: 16px;
            background: transparent;
        }

        .camera-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 20px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-close {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .camera-capture {
            background: #00b4d8;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .camera-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 16px;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
        }

        .result-section {
            display: none;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #e0e0e0;
        }

        .result-category.danger {
            background: #ffe0e0;
            border-left-color: #d63031;
        }

        .result-category.warning {
            background: #fff4e0;
            border-left-color: #f39c12;
        }

        .result-category.caution {
            background: #ffe0f0;
            border-left-color: #e91e63;
        }

        .result-category.info {
            background: #e8e0ff;
            border-left-color: #6c5ce7;
        }

        .result-category.success {
            background: #e0ffe0;
            border-left-color: #27ae60;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .ingredient-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .ingredient-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .ingredient-reason {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .alternate-names {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
        }

        .product-info {
            background: #f0f8ff;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .product-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .product-brand {
            color: #666;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #666;
            text-decoration: none;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .offline-indicator {
            background: #ff6b6b;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:active {
            background: #f0f0f0;
        }

        .history-date {
            font-size: 12px;
            color: #999;
        }

        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 18px;
            z-index: 20;
        }

        .processing-overlay.active {
            display: flex;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #fff;
            }
            
            .card, .ingredient-item, .history-item {
                background: #2a2a2a;
                color: #fff;
            }
            
            .app-header {
                background: linear-gradient(135deg, #4a5fc7 0%, #5a3a82 100%);
            }
            
            textarea {
                background: #2a2a2a;
                color: #fff;
                border-color: #444;
            }
            
            .btn-secondary {
                background: #3a3a3a;
                color: #fff;
            }
            
            .bottom-nav {
                background: #2a2a2a;
                border-top: 1px solid #444;
            }
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 200;
        }

        .install-prompt h3 {
            margin-bottom: 8px;
            font-size: 18px;
        }

        .install-prompt p {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .install-buttons {
            display: flex;
            gap: 12px;
        }

        .install-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .install-btn.primary {
            background: #667eea;
            color: white;
        }

        .install-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        You are offline - Some features may be limited
    </div>

    <div class="app-header">
        <h1>ü§∞ SafeBump</h1>
    </div>

    <div class="container">
        <div id="scanPage" class="page">
            <div class="card">
                <button class="scan-button" id="scanBtn">
                    <svg class="scan-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    Scan Ingredients Label
                </button>
            </div>

            <div class="divider">
                <span>OR</span>
            </div>

            <div class="card">
                <div class="product-info" id="productInfo">
                    <div class="product-name" id="productName"></div>
                    <div class="product-brand" id="productBrand"></div>
                </div>

                <textarea id="ingredientInput" placeholder="Paste or type ingredient list here...&#10;&#10;Example:&#10;Water, Glycerin, Lanolin, Fragrance, etc."></textarea>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="checkBtn">Check Safety</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear</button>
                </div>
            </div>

            <div id="results" class="result-section"></div>
        </div>

        <div id="historyPage" class="page" style="display: none;">
            <div class="card">
                <h2>Scan History</h2>
                <div id="historyList" class="history-list"></div>
            </div>
        </div>

        <div id="settingsPage" class="page" style="display: none;">
            <div class="card">
                <h2>Settings</h2>
                <div style="margin-top: 20px;">
                    <h3>Your Allergies</h3>
                    <p style="color: #666; font-size: 14px; margin-top: 8px;">
                        These are currently hardcoded. In a future update, you'll be able to customize your allergy list.
                    </p>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearHistory()">Clear Scan History</button>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="#scan" class="nav-item active" data-page="scanPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Scan
        </a>
        <a href="#history" class="nav-item" data-page="historyPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            History
        </a>
        <a href="#settings" class="nav-item" data-page="settingsPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m4.22-10.22l4.24 4.24M6.34 6.34L2.1 2.1m17.8 17.8l-4.24-4.24M17.66 17.66l4.24 4.24M2.1 21.9l4.24-4.24M6.34 17.66L2.1 21.9"></path>
            </svg>
            Settings
        </a>
    </nav>

    <div id="camera-modal" class="camera-modal">
        <video id="camera-video"></video>
        <div class="camera-overlay">
            <div class="camera-viewfinder"></div>
        </div>
        <div class="camera-header">
            <button class="camera-close" id="closeCamera">Close</button>
            <button class="camera-capture" id="captureBtn">Capture</button>
        </div>
        <div class="camera-hint">
            Position ingredient list in the blue frame and tap Capture
        </div>
        <div class="processing-overlay" id="processingOverlay">
            <div class="loading"></div>
            <div style="margin-top: 20px;">Reading ingredients...</div>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <h3>Install SafeBump</h3>
        <p>Add to your home screen for quick access and offline use</p>
        <div class="install-buttons">
            <button class="install-btn primary" id="installBtn">Install</button>
            <button class="install-btn secondary" id="laterBtn">Later</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {
        console.log('Service worker registration failed - running without offline support');
    });
}

// Offline Detection
window.addEventListener('online', () => {
    document.getElementById('offlineIndicator').style.display = 'none';
});

window.addEventListener('offline', () => {
    document.getElementById('offlineIndicator').style.display = 'block';
});

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installPrompt').style.display = 'block';
});

document.getElementById('installBtn').addEventListener('click', () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            deferredPrompt = null;
            document.getElementById('installPrompt').style.display = 'none';
        });
    }
});

document.getElementById('laterBtn').addEventListener('click', () => {
    document.getElementById('installPrompt').style.display = 'none';
});

// Database of allergens and unsafe ingredients
const allergenDatabase = {
    confirmedAllergies: {
        'Disperse Blue 106/124 Mix': {
            alternates: ['disperse blue 106/124 mix', 'disperse blue 106', 'disperse blue 124', 'db 106', 'db 124', 'c.i. disperse blue 106', 'c.i. disperse blue 124'],
            reason: 'Textile dye allergen'
        },
        'Lanolin Alcohol (Wool Alcohol)': {
            alternates: ['lanolin', 'lanolin alcohol', 'wool alcohol', 'wool fat', 'wool wax', 'anhydrous lanolin', 'lanolin oil', 'lanolin acid', 'lanolin, ethoxylated', 'lanolin wax', 'lanolate', 'alcolanum', 'amerchol', 'lanogene', 'lanichol', 'lanolin usp', 'wool grease', 'adeps lanae'],
            reason: 'Wool-derived emollient allergen'
        },
        'Carba Mix': {
            alternates: ['carba mix', '1,3-diphenylguanidine', 'dpg', 'n,n\'-diphenylguanidine', 'zinc diethyldithiocarbamate', 'zdec', 'zinc dibutyldithiocarbamate', 'zdbc', 'diphenylguanidine'],
            reason: 'Rubber accelerator allergen'
        },
        'Balsam of Peru': {
            alternates: ['balsam of peru', 'myroxylon pereirae', 'balsamum peruvianum', 'peru balsam', 'balsam peru oil', 'black balsam', 'china oil', 'honduras balsam', 'indian balsam', 'peruvian balsam', 'surinam balsam', 'balsams, copaiba', 'balsam fir oil', 'cinnamic acid', 'cinnamic alcohol', 'cinnamic aldehyde', 'eugenol', 'isoeugenol', 'benzyl acetate', 'benzyl alcohol', 'benzyl cinnamate', 'vanilla', 'vanillin'],
            reason: 'Complex fragrance allergen with cross-reactions'
        },
        '1,3-Diphenylguanidine (DPG)': {
            alternates: ['1,3-diphenylguanidine', 'dpg', 'n,n\'-diphenylguanidine', 'diphenylguanidine', 'vulkazit', 'denax', 'dpg accelerator'],
            reason: 'Rubber accelerator allergen'
        },
        '4,4\'-Dithiodimorpholine (DTDM)': {
            alternates: ['4,4\'-dithiodimorpholine', 'dtdm', 'dimorpholinyl disulfide', 'disulfide, bis(4-morpholinyl)', 'morpholine disulfide', 'bis(morpholino) disulfide'],
            reason: 'Rubber accelerator allergen'
        },
        'Benzisothiazolinone': {
            alternates: ['benzisothiazolinone', 'bit', '1,2-benzisothiazol-3(2h)-one', 'proxel', 'proxel crl', 'proxel gxl', 'proxel xj', 'proxel ls'],
            reason: 'Preservative allergen'
        }
    },
    potentialAllergies: {
        'Mercaptobenzothiazole': {
            alternates: ['mercaptobenzothiazole', 'mbt', '2-mercaptobenzothiazole', 'captax', 'thiotax', 'mertax', 'benzothiazole-2-thiol'],
            reason: 'Rubber accelerator - potential allergen'
        },
        'Ethylenediamine Dihydrochloride': {
            alternates: ['ethylenediamine dihydrochloride', 'ethylenediamine', 'eda', '1,2-ethanediamine', 'edamine', 'ethylene diamine'],
            reason: 'Stabilizer - potential allergen'
        },
        'Black Rubber Mix': {
            alternates: ['black rubber mix', 'n-isopropyl-n\'-phenyl-p-phenylenediamine', 'ippd', 'n-cyclohexyl-n\'-phenyl-p-phenylenediamine', 'cppd', 'n,n\'-diphenyl-p-phenylenediamine', 'dppd'],
            reason: 'Rubber antioxidant - potential allergen'
        },
        'Nickel Sulfate': {
            alternates: ['nickel sulfate', 'nickel', 'nickel chloride', 'nickel acetate', 'nickel carbonate', 'nickel hydroxide', 'nickel oxide'],
            reason: 'Metal allergen - potential sensitizer'
        },
        'Propylene Glycol (PG)': {
            alternates: ['propylene glycol', 'pg', '1,2-propanediol', '1,2-dihydroxypropane', 'methyl glycol', 'trimethyl glycol', 'propane-1,2-diol'],
            reason: 'Solvent/humectant - potential irritant'
        },
        'Fragrance Mix I': {
            alternates: ['fragrance mix i', 'fragrance mix', 'fragrance', 'parfum', 'perfume', 'aroma', 'essential oil blend', 'cinnamic alcohol', 'cinnamic aldehyde', 'eugenol', 'isoeugenol', 'geraniol', 'hydroxycitronellal', 'oak moss absolute', 'evernia prunastri'],
            reason: 'Common fragrance allergens - potential sensitizer'
        },
        'Propolis': {
            alternates: ['propolis', 'bee glue', 'bee propolis', 'propolis extract', 'propolis wax', 'propolis resin', 'propolis cera', 'cera alba'],
            reason: 'Bee product - potential allergen'
        },
        'Cocamidopropyl Betaine (CAPB)': {
            alternates: ['cocamidopropyl betaine', 'capb', 'cocobetaine', 'coco betaine', 'coconut betaine', 'lauramidopropyl betaine', 'cocoamphodipropionate'],
            reason: 'Surfactant - potential sensitizer'
        },
        'Lauryl Polyglucose (Glucosides)': {
            alternates: ['lauryl polyglucose', 'lauryl glucoside', 'dodecyl glucoside', 'c12-16 alkyl glucoside', 'alkyl polyglucoside', 'apg', 'plantacare'],
            reason: 'Surfactant - potential allergen'
        },
        'Sorbitan Sesquioleate': {
            alternates: ['sorbitan sesquioleate', 'arlacel 83', 'sorbitan oleate', 'span 80', 'sorbitan monooleate', 'sorbitol oleate'],
            reason: 'Emulsifier - potential sensitizer'
        },
        'Benzoic Acid': {
            alternates: ['benzoic acid', 'benzenecarboxylic acid', 'carboxybenzene', 'e210', 'benzoate', 'sodium benzoate', 'potassium benzoate'],
            reason: 'Preservative - potential irritant'
        },
        'Hydroperoxides of Limonene': {
            alternates: ['hydroperoxides of limonene', 'limonene hydroperoxides', 'limonene', 'd-limonene', 'l-limonene', 'dipentene', 'oxidized limonene', 'limonene oxide'],
            reason: 'Fragrance - oxidizes to allergen'
        },
        'Polymyxin B': {
            alternates: ['polymyxin b', 'polymyxin b sulfate', 'aerosporin', 'poly-rx', 'pmb'],
            reason: 'Antibiotic - potential allergen'
        },
        'Peppermint': {
            alternates: ['peppermint', 'mentha piperita', 'peppermint oil', 'menthol', 'mentha oil', 'mint extract', 'peppermint extract', 'peppermint leaf extract'],
            reason: 'Essential oil - potential sensitizer (topical only)'
        }
    }
};

// Pregnancy unsafe ingredients
const pregnancyUnsafe = {
    'Retinol/Retinoids': {
        alternates: ['retinol', 'retinyl palmitate', 'retinyl acetate', 'vitamin a', 'retinoids', 'retinoic acid', 'tretinoin', 'isotretinoin', 'adapalene', 'tazarotene', 'retinaldehyde', 'retinal', 'retin-a', 'differin', 'retinyl esters'],
        reason: 'Can cause birth defects',
        type: 'both'
    },
    'Salicylic Acid': {
        alternates: ['salicylic acid', 'bha', 'beta hydroxy acid', 'salicylate', 'aspirin', 'acetylsalicylic acid', 'willow bark extract', 'salix alba', 'ortho-hydroxybenzoic acid'],
        reason: 'High doses linked to pregnancy complications',
        type: 'both'
    },
    'Hydroquinone': {
        alternates: ['hydroquinone', '1,4-benzenediol', 'benzene-1,4-diol', 'quinol', 'hydroquinol', 'eldoquin', 'eldopaque', 'melanex', 'hydrochinone', 'p-dihydroxybenzene'],
        reason: 'High systemic absorption rate',
        type: 'topical'
    },
    'Formaldehyde': {
        alternates: ['formaldehyde', 'formalin', 'formic aldehyde', 'methanal', 'methylene oxide', 'quaternium-15', 'dmdm hydantoin', 'imidazolidinyl urea', 'diazolidinyl urea', 'sodium hydroxymethylglycinate', 'bronopol', '2-bromo-2-nitropropane-1,3-diol', 'glyoxal', 'methanediol'],
        reason: 'Carcinogen and pregnancy risk',
        type: 'topical'
    },
    'Phthalates': {
        alternates: ['phthalates', 'dbp', 'dehp', 'dep', 'dibutyl phthalate', 'diethylhexyl phthalate', 'diethyl phthalate', 'dimethyl phthalate', 'dmp', 'fragrance', 'parfum'],
        reason: 'Endocrine disruptors',
        type: 'both'
    },
    'Oxybenzone': {
        alternates: ['oxybenzone', 'benzophenone-3', 'bp-3', '2-hydroxy-4-methoxybenzophenone', 'milestab 9', 'eusolex 4360', 'escalol 567'],
        reason: 'May reach fetus and cause harmful cell changes',
        type: 'topical'
    },
    'Parabens': {
        alternates: ['parabens', 'methylparaben', 'ethylparaben', 'propylparaben', 'butylparaben', 'isobutylparaben', 'isopropylparaben', 'benzylparaben'],
        reason: 'Disrupts hormones and thyroid function',
        type: 'both'
    },
    'Aluminum Compounds': {
        alternates: ['aluminum compounds', 'aluminum chloride', 'aluminum chlorohydrate', 'aluminum zirconium', 'drysol', 'certain dri', 'aluminium chloride', 'sodium aluminum phosphate', 'aluminum hydroxide', 'aluminum oxide'],
        reason: 'May cause neurological effects - limit use',
        type: 'both'
    }
};

// Generally unsafe ingredients
const generallyUnsafe = {
    'Lead': {
        alternates: ['lead', 'lead acetate', 'lead compounds', 'pb'],
        reason: 'Neurotoxin'
    },
    'Mercury': {
        alternates: ['mercury', 'thimerosal', 'mercurous chloride', 'calomel', 'mercurio', 'mercury compounds'],
        reason: 'Neurotoxin'
    },
    'Triclosan': {
        alternates: ['triclosan', 'microban', 'irgasan', 'cloxifenolum', 'triclocarban'],
        reason: 'Endocrine disruptor'
    },
    'Sodium Lauryl Sulfate': {
        alternates: ['sodium lauryl sulfate', 'sls', 'sodium dodecyl sulfate', 'sds', 'sodium laureth sulfate', 'sles'],
        reason: 'Harsh surfactant - can cause irritation'
    }
};

// Normalize ingredient names for matching
function normalizeIngredient(ingredient) {
    return ingredient.toLowerCase().trim().replace(/[^\w\s-]/g, '');
}

// Camera functionality
let stream = null;
let cameraActive = false;

document.getElementById('scanBtn').addEventListener('click', startCamera);
document.getElementById('closeCamera').addEventListener('click', stopCamera);
document.getElementById('captureBtn').addEventListener('click', captureImage);

async function startCamera() {
    const modal = document.getElementById('camera-modal');
    
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            } 
        });
        
        const video = document.getElementById('camera-video');
        video.srcObject = stream;
        
        modal.classList.add('active');
        cameraActive = true;
        
    } catch (err) {
        alert('Camera access denied. Please allow camera access and try again.');
        console.error('Camera error:', err);
    }
}

function stopCamera() {
    const modal = document.getElementById('camera-modal');
    
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    modal.classList.remove('active');
    cameraActive = false;
}

async function captureImage() {
    if (!stream) return;
    
    const video = document.getElementById('camera-video');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    
    // Set canvas size to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw current video frame to canvas
    context.drawImage(video, 0, 0);
    
    // Convert to blob
    canvas.toBlob(async (blob) => {
        // Show processing overlay
        document.getElementById('processingOverlay').classList.add('active');
        
        try {
            // Process with Tesseract OCR
            const result = await Tesseract.recognize(blob, 'eng', {
                logger: m => console.log(m)
            });
            
            // Hide processing overlay
            document.getElementById('processingOverlay').classList.remove('active');
            
            const extractedText = result.data.text.trim();
            
            if (extractedText) {
                // Clean up the extracted text
                const cleanedText = cleanupOCRText(extractedText);
                
                // Close camera and populate text area
                stopCamera();
                document.getElementById('ingredientInput').value = cleanedText;
                
                // Show product info
                const productInfo = document.getElementById('productInfo');
                const productName = document.getElementById('productName');
                const productBrand = document.getElementById('productBrand');
                
                productInfo.style.display = 'block';
                productName.textContent = 'Ingredients scanned from photo';
                productBrand.textContent = 'Check the results below and edit if needed';
                
                // Automatically check ingredients
                checkIngredients();
                
                // Save to history
                saveToHistory({
                    type: 'ocr',
                    name: 'OCR Scan',
                    ingredients: cleanedText,
                    timestamp: new Date().toISOString()
                });
                
            } else {
                alert('Could not read text from image. Please try again with better lighting or a clearer photo.');
            }
            
        } catch (error) {
            // Hide processing overlay
            document.getElementById('processingOverlay').classList.remove('active');
            console.error('OCR Error:', error);
            alert('Error processing image. Please try again.');
        }
    }, 'image/jpeg', 0.8);
}

function cleanupOCRText(text) {
    // Remove common OCR artifacts and clean up the text
    let cleaned = text
        .replace(/[|]/g, 'I')  // Replace pipes with I
        .replace(/[""]/g, '"') // Normalize quotes
        .replace(/['']/g, "'") // Normalize apostrophes
        .replace(/\s+/g, ' ')  // Multiple spaces to single space
        .replace(/\n+/g, ', ') // Newlines to commas
        .replace(/[,\s]+/g, ', ') // Clean up comma spacing
        .replace(/,\s*,+/g, ',') // Remove double commas
        .replace(/^,\s*/, '') // Remove leading comma
        .replace(/,\s*$/, '') // Remove trailing comma
        .trim();
    
    return cleaned;
}

// Check ingredients (same function as before)
function checkIngredients() {
    const input = document.getElementById('ingredientInput').value;
    if (!input.trim()) {
        alert('Please enter some ingredients to check');
        return;
    }

    const ingredients = input.split(/[,;:\n]/).map(i => i.trim()).filter(i => i);
    
    const results = {
        confirmedAllergies: [],
        potentialAllergies: [],
        pregnancyUnsafe: [],
        generallyUnsafe: [],
        safe: []
    };

    ingredients.forEach(ingredient => {
        const normalizedIngredient = normalizeIngredient(ingredient);
        let found = false;

        // Check confirmed allergies
        for (const [allergen, data] of Object.entries(allergenDatabase.confirmedAllergies)) {
            const normalizedAllergen = normalizeIngredient(allergen);
            if (normalizedAllergen === normalizedIngredient || 
                data.alternates.some(alt => normalizeIngredient(alt) === normalizedIngredient)) {
                results.confirmedAllergies.push({
                    ingredient: ingredient,
                    allergen: allergen,
                    reason: data.reason,
                    alternates: data.alternates
                });
                found = true;
                break;
            }
        }

        // Check potential allergies
        if (!found) {
            for (const [allergen, data] of Object.entries(allergenDatabase.potentialAllergies)) {
                const normalizedAllergen = normalizeIngredient(allergen);
                if (normalizedAllergen === normalizedIngredient || 
                    data.alternates.some(alt => normalizeIngredient(alt) === normalizedIngredient)) {
                    results.potentialAllergies.push({
                        ingredient: ingredient,
                        allergen: allergen,
                        reason: data.reason,
                        alternates: data.alternates
                    });
                    found = true;
                    break;
                }
            }
        }

        // Check pregnancy unsafe
        if (!found) {
            for (const [unsafe, data] of Object.entries(pregnancyUnsafe)) {
                const normalizedUnsafe = normalizeIngredient(unsafe);
                if (normalizedUnsafe === normalizedIngredient || 
                    data.alternates.some(alt => normalizeIngredient(alt) === normalizedIngredient)) {
                    results.pregnancyUnsafe.push({
                        ingredient: ingredient,
                        unsafe: unsafe,
                        reason: data.reason,
                        alternates: data.alternates,
                        type: data.type
                    });
                    found = true;
                    break;
                }
            }
        }

        // Check generally unsafe
        if (!found) {
            for (const [unsafe, data] of Object.entries(generallyUnsafe)) {
                const normalizedUnsafe = normalizeIngredient(unsafe);
                if (normalizedUnsafe === normalizedIngredient || 
                    data.alternates.some(alt => normalizeIngredient(alt) === normalizedIngredient)) {
                    results.generallyUnsafe.push({
                        ingredient: ingredient,
                        unsafe: unsafe,
                        reason: data.reason,
                        alternates: data.alternates
                    });
                    found = true;
                    break;
                }
            }
        }

        if (!found) {
            results.safe.push(ingredient);
        }
    });

    displayResults(results);
    
    // Save check to history
    saveToHistory({
        type: 'manual',
        ingredients: input,
        results: results,
        timestamp: new Date().toISOString()
    });
}

// Display results (same function as before)
function displayResults(results) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    
    let html = '';
    
    const hasConcerns = results.confirmedAllergies.length > 0 || 
                       results.potentialAllergies.length > 0 || 
                       results.pregnancyUnsafe.length > 0 || 
                       results.generallyUnsafe.length > 0;

    if (!hasConcerns && results.safe.length > 0) {
        html = '<div class="card"><div class="result-category success">';
        html += '<div class="category-header">‚úÖ All Clear!</div>';
        html += '<div class="ingredient-item">';
        html += '<div class="ingredient-name">All ingredients appear to be safe:</div>';
        html += `<div class="ingredient-reason">${results.safe.join(', ')}</div>`;
        html += '</div></div></div>';
    } else {
        html = '<div class="card">';
        
        if (results.confirmedAllergies.length > 0) {
            html += '<div class="result-category danger">';
            html += '<div class="category-header">‚ö†Ô∏è Confirmed Allergies (1+)</div>';
            results.confirmedAllergies.forEach(item => {
                html += '<div class="ingredient-item">';
                html += `<div class="ingredient-name">"${item.ingredient}" ‚Üí ${item.allergen}</div>`;
                html += `<div class="ingredient-reason">${item.reason}</div>`;
                html += `<div class="alternate-names">Also known as: ${item.alternates.slice(0, 3).join(', ')}...</div>`;
                html += '</div>';
            });
            html += '</div>';
        }

        if (results.potentialAllergies.length > 0) {
            html += '<div class="result-category warning">';
            html += '<div class="category-header">‚ùì Potential Allergies (?)</div>';
            results.potentialAllergies.forEach(item => {
                html += '<div class="ingredient-item">';
                html += `<div class="ingredient-name">"${item.ingredient}" ‚Üí ${item.allergen}</div>`;
                html += `<div class="ingredient-reason">${item.reason}</div>`;
                html += `<div class="alternate-names">Also known as: ${item.alternates.slice(0, 3).join(', ')}...</div>`;
                html += '</div>';
            });
            html += '</div>';
        }

        if (results.pregnancyUnsafe.length > 0) {
            html += '<div class="result-category caution">';
            html += '<div class="category-header">ü§∞ Pregnancy Concerns</div>';
            results.pregnancyUnsafe.forEach(item => {
                html += '<div class="ingredient-item">';
                html += `<div class="ingredient-name">"${item.ingredient}" ‚Üí ${item.unsafe}</div>`;
                html += `<div class="ingredient-reason">${item.reason}`;
                if (item.type) {
                    const typeLabel = item.type === 'both' ? ' (Topical & Oral)' : 
                                     item.type === 'topical' ? ' (Topical)' : ' (Oral)';
                    html += `<strong>${typeLabel}</strong>`;
                }
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
        }

        if (results.generallyUnsafe.length > 0) {
            html += '<div class="result-category info">';
            html += '<div class="category-header">‚ö†Ô∏è Generally Harmful</div>';
            results.generallyUnsafe.forEach(item => {
                html += '<div class="ingredient-item">';
                html += `<div class="ingredient-name">"${item.ingredient}" ‚Üí ${item.unsafe}</div>`;
                html += `<div class="ingredient-reason">${item.reason}</div>`;
                html += '</div>';
            });
            html += '</div>';
        }

        if (results.safe.length > 0) {
            html += '<div class="result-category success">';
            html += '<div class="category-header">‚úÖ Safe Ingredients</div>';
            html += '<div class="ingredient-item">';
            html += `<div class="ingredient-name">${results.safe.join(', ')}</div>`;
            html += '</div>';
            html += '</div>';
        }
        
        html += '</div>';
    }

    resultsDiv.innerHTML = html;
}

// Local storage functions (same as before)
function saveToHistory(data) {
    const history = getHistory();
    history.unshift(data);
    if (history.length > 50) history.pop();
    localStorage.setItem('scanHistory', JSON.stringify(history));
}

function getHistory() {
    return JSON.parse(localStorage.getItem('scanHistory') || '[]');
}

function displayHistory() {
    const historyList = document.getElementById('historyList');
    const history = getHistory();
    
    if (history.length === 0) {
        historyList.innerHTML = '<p style="color: #999;">No scan history yet</p>';
        return;
    }
    
    let html = '';
    history.forEach((item, index) => {
        const date = new Date(item.timestamp);
        html += `<div class="history-item" onclick="loadHistoryItem(${index})">`;
        html += `<div class="product-name">${item.name || 'Manual Check'}</div>`;
        if (item.brand) html += `<div class="product-brand">${item.brand}</div>`;
        html += `<div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>`;
        html += '</div>';
    });
    
    historyList.innerHTML = html;
}

function loadHistoryItem(index) {
    const history = getHistory();
    const item = history[index];
    
    if (item.ingredients) {
        document.getElementById('ingredientInput').value = item.ingredients;
        showPage('scanPage');
        checkIngredients();
    }
}

function clearHistory() {
    if (confirm('Clear all scan history?')) {
        localStorage.removeItem('scanHistory');
        displayHistory();
    }
}

function exportData() {
    const history = getHistory();
    const dataStr = JSON.stringify(history, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `safebump-history-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// Navigation (same as before)
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
    });
    document.getElementById(pageId).style.display = 'block';
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
    
    if (pageId === 'historyPage') {
        displayHistory();
    }
}

// Event listeners
document.getElementById('checkBtn').addEventListener('click', checkIngredients);
document.getElementById('clearBtn').addEventListener('click', () => {
    document.getElementById('ingredientInput').value = '';
    document.getElementById('results').innerHTML = '';
    document.getElementById('results').style.display = 'none';
    document.getElementById('productInfo').style.display = 'none';
});

document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
        e.preventDefault();
        const pageId = item.dataset.page;
        showPage(pageId);
    });
});

// Initialize
showPage('scanPage');
    </script>
</body>
</html>
